stages:
  - test
  - deploy

variables:
  PRE_COMMIT_HOME: ${CI_PROJECT_DIR}/.cache/pre-commit
  PIXI_PLATFORM: linux-64

# ===== PRE-COMMIT =====
pre-commit:
  image: ghcr.io/prefix-dev/pixi:latest
  stage: test
  script:
    - apt update && apt install -y git
    - pip install pre-commit --break-system-packages
    - pre-commit run --all-files
  cache:
    key: pre-commit-cache
    paths:
      - ${PRE_COMMIT_HOME}
  tags:
    - linux
  allow_failure: true

# ===== LINT =====
lint:
  image: ghcr.io/prefix-dev/pixi:latest
  stage: test
  script:
    - apt update && apt install -y git
    - pixi install
    - pixi run lint
  tags:
    - linux
  allow_failure: true

# ===== TEST =====
test:
  image: ghcr.io/prefix-dev/pixi:latest
  stage: test
  script:
    - apt update && apt install -y git
    - pixi install
    - pixi run test-cov
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    paths:
      - htmlcov/
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    when: always
    expire_in: 1 week
  tags:
    - linux

# ===== TEST ALL (MANUAL) =====
test-all:
  image: ghcr.io/prefix-dev/pixi:latest
  stage: test
  script:
    - apt update && apt install -y git
    - pixi install
    - pixi run test-all
  tags:
    - linux
  when: manual
  allow_failure: true

# ===== PAGES (COVERAGE REPORT + BADGE) =====
pages:
  image: ghcr.io/prefix-dev/pixi:latest
  stage: deploy
  needs:
    - test
  script:
    - pip install coverage-badge --break-system-packages
    - mkdir -p public
    - coverage-badge -o public/coverage.svg -f || true
    - cp -r htmlcov/* public/ || true
  artifacts:
    paths:
      - public
  tags:
    - linux
  only:
    - main
    - master
